# HTML to Markdown Conversion Design

This document describes the bidirectional conversion between Intercom HTML and local Markdown files.

## Overview

```
┌─────────────┐     pull      ┌─────────────┐
│  Intercom   │ ───────────▶  │  Markdown   │  (git tracked)
│    HTML     │               │   .md       │
└─────────────┘               └─────────────┘
       ▲                             │
       │           push              │
       └─────────────────────────────┘
                    │
              ┌─────────────┐
              │  .original  │  (git ignored, HTML backup)
              │    .html    │
              └─────────────┘
```

## Directory Structure

```
help-docs/
├── articles/
│   └── ja/12345/article-title.md     # Markdown (git tracked)
├── .original/
│   └── ja/12345/article-title.html   # Original HTML (git ignored)
└── .intercom-config.json
```

## Conversion Rules

### 1. Headings

| HTML | Markdown |
|------|----------|
| `<h1 id="h_xxx">Title</h1>` | `# Title` |
| `<h2 id="h_xxx">Title</h2>` | `## Title` |
| `<h3 id="h_xxx">Title</h3>` | `### Title` |
| `<h4 id="h_xxx">Title</h4>` | `#### Title` |

Note: Heading IDs (`id="h_xxx"`) are auto-generated by Intercom and will be regenerated on push.

### 2. Text Formatting

| HTML | Markdown |
|------|----------|
| `<b>text</b>` or `<strong>text</strong>` | `**text**` |
| `<i>text</i>` or `<em>text</em>` | `*text*` |
| `<code>text</code>` | `` `text` `` |
| `<b><i>text</i></b>` | `***text***` |
| `<p class="no-margin">text</p>` | `text` (paragraph) |
| `<br>` | Line break or `<br>` |

Combinations are supported: `<b><i><code>text</code></i></b>` → `` ***`text`*** ``

### 3. Text Alignment

Text alignment classes are preserved as HTML comments:

| HTML | Markdown |
|------|----------|
| `<p class="intercom-align-center no-margin">text</p>` | `<!-- align:center -->text` |
| `<p class="intercom-align-right no-margin">text</p>` | `<!-- align:right -->text` |
| `<p class="intercom-align-justify no-margin">text</p>` | `<!-- align:justify -->text` |
| `<p class="no-margin">text</p>` (left, default) | `text` |

Headings with alignment:
| HTML | Markdown |
|------|----------|
| `<h2 class="intercom-align-center">Title</h2>` | `<!-- align:center -->## Title` |

### 4. Lists

| HTML | Markdown |
|------|----------|
| `<ul><li>item</li></ul>` | `- item` |
| `<ol><li>item</li></ol>` | `1. item` |

### 5. Links

| HTML | Markdown |
|------|----------|
| `<a href="url" class="intercom-content-link">text</a>` | `[text](url)` |
| `<a href="url" target="_blank">text</a>` | `[text](url)` |

### 6. Images

| HTML | Markdown |
|------|----------|
| `<div class="intercom-container"><img src="url" alt="desc"></div>` | `![desc](url)` |
| `<div class="intercom-container intercom-align-center"><img src="url"></div>` | `<!-- align:center -->![](url)` |

On push: All images are wrapped with `<div class="intercom-container">`.

**Image URL Handling:**
- Pull: URLs are preserved as-is (including Intercom CDN URLs with signatures)
- Push: URLs are kept unchanged; Intercom will re-host if needed

### 7. Videos (YouTube, etc.)

Embedded videos are kept as raw HTML:

```html
<div class="intercom-h2b-video"><iframe src="https://www.youtube.com/embed/VIDEO_ID?rel=0" frameborder="0" allowfullscreen></iframe></div>
```

In Markdown, preserve as-is or use a shorthand:

```markdown
<!-- video:youtube:VIDEO_ID -->
```

### 8. Buttons

Buttons are kept as raw HTML:

```html
<div class="intercom-container"><a class="intercom-h2b-button" target="_blank" href="https://example.com">Button Text</a></div>
```

Or use a shorthand in Markdown:

```markdown
<!-- button:https://example.com -->Button Text<!-- /button -->
```

### 9. Callouts (Colored Boxes)

Intercom supports 5 callout colors. We use fenced code blocks with special language identifiers:

| Color | HTML Background | Markdown |
|-------|-----------------|----------|
| Gray | `#e8e8e880` | ` ```callout-gray ` |
| Blue | `#e3e7fa80` | ` ```callout-blue ` |
| Green | `#d7efdc80` | ` ```callout-green ` |
| Red | `#fed9db80` | ` ```callout-red ` |
| Yellow | `#feedaf80` | ` ```callout-yellow ` |

**Example:**

HTML:
```html
<div class="intercom-interblocks-callout" style="background-color: #feedaf80; border-color: #fbc91633;">
  <p class="no-margin"><b>Warning:</b> This is important.</p>
</div>
```

Markdown:
````markdown
```callout-yellow
**Warning:** This is important.
```
````

### 10. Code Blocks

Standard Markdown code blocks with optional language identifiers.

**Default rule:** Fenced code blocks without language identifier are treated as code blocks (not callouts).

````markdown
```
plain code without syntax highlighting
```
````

With language specified:

````markdown
```javascript
const x = 1;
```
````

HTML:
```html
<pre><code>const x = 1;</code></pre>
```

Note: Callouts must be explicitly specified with `callout-{color}`. A bare ` ``` ` block is always a code block.

### 11. Tables

Tables are converted to standard Markdown table syntax:

HTML:
```html
<div class="intercom-interblocks-table-container"><table role="presentation"><tbody>
  <tr><td><p class="no-margin">1-1</p></td><td><p class="no-margin">1-2</p></td></tr>
  <tr><td><p class="no-margin">2-1</p></td><td><p class="no-margin">2-2</p></td></tr>
</tbody></table></div>
```

Markdown:
```markdown
| 1-1 | 1-2 |
| --- | --- |
| 2-1 | 2-2 |
```

The first row is treated as the header row. On push, Markdown tables are converted back to Intercom's HTML table format.

### 12. Collapsible Sections (Accordion)

Kept as raw HTML in Markdown. Supports nesting and headings inside:

```html
<details><summary><h2>Section Title</h2></summary>
<div class="collapsible-section-content">

Content here...

<details><summary><h2>Nested Section</h2></summary>
<div class="collapsible-section-content">
Nested content...
</div></details>

</div></details>
```

### 13. Horizontal Rules

| HTML | Markdown |
|------|----------|
| `<hr>` | `---` |

### 14. Attachments (PDF, etc.)

Attachments are stored in the front matter metadata:

```yaml
---
intercom_id: '13000987'
title: Article Title
attachments:
  - name: "document.pdf"
    url: "https://intercom-attachments.com/..."
  - name: "spreadsheet.xlsx"
    url: "https://intercom-attachments.com/..."
---
```

This approach:
- Preserves attachment URLs
- Keeps the article body clean
- Makes attachments explicitly visible in metadata

## Push Workflow

1. Read the Markdown file
2. Fetch the latest HTML from Intercom API
3. Convert Markdown to HTML
4. **Merge with fetched HTML:**
   - Preserve image URLs from fetched HTML (maintain signatures)
   - Preserve any Intercom-specific attributes not in Markdown
5. Upload to Intercom
6. Update `.original/` with the new HTML

## Color Code Reference

| Color | Background | Border |
|-------|------------|--------|
| Gray | `#e8e8e880` | `#73737633` |
| Blue | `#e3e7fa80` | `#334bfa33` |
| Green | `#d7efdc80` | `#1bb15733` |
| Red | `#fed9db80` | `#fd3a5733` |
| Yellow | `#feedaf80` | `#fbc91633` |

## Limitations

1. **Heading IDs**: Auto-generated IDs are not preserved; Intercom regenerates them
2. **Complex nested structures**: May require manual adjustment
3. **Video embeds**: Must be kept as raw HTML

## Supported Elements Summary

| Element | Conversion | Notes |
|---------|------------|-------|
| Headings (h1-h4) | Full | IDs regenerated |
| Bold/Italic/Code | Full | Including combinations |
| Text alignment | Via comments | `<!-- align:center -->` |
| Lists (ul/ol) | Full | |
| Links | Full | |
| Images | Full | URLs preserved |
| Videos | Raw HTML | YouTube, Vimeo, etc. |
| Buttons | Raw HTML | |
| Callouts | Via fence | `callout-{color}` |
| Code blocks | Full | Standard Markdown |
| Tables | Full | Standard Markdown tables |
| Collapsible | Raw HTML | With nesting |
| Horizontal rule | Full | `---` |
| Attachments | Via front matter | Stored in metadata |
